name: Release

on:
  push:
    tags: ["v*"]

jobs:
  release:
    name: Release
    runs-on: ubuntu-24.04
    permissions:
      actions: write
      contents: write
      # For keyless signing with cosign
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Install Rust
        run: |
          set -eux -o pipefail
          rustup toolchain install stable
          rustup default stable
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.22.2
      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2.2.1
        with:
          version: 0.15.2
      - name: Install zigbuild crate
        run: cargo install --locked cargo-zigbuild
      - name: Cache macOS SDK
        id: cache-macos-sdk
        uses: actions/cache@v4.2.1
        with:
          path: ${{ runner.temp }}/macos-sdk
          key: macosx-sdk-26.1
      - name: Prepare macOS SDK
        env:
          SDK_URL: https://github.com/joseluisq/macosx-sdks/releases/download/26.1/MacOSX26.1.sdk.tar.xz
          SDK_CACHED: ${{ steps.cache-macos-sdk.outputs.cache-hit }}
        run: |
          set -eux -o pipefail
          SDK_DIR="${RUNNER_TEMP}/macos-sdk"
          mkdir -p "$SDK_DIR"
          if [ "$SDK_CACHED" != "true" ]; then
            curl -L "$SDK_URL" -o "$SDK_DIR/MacOSX.sdk.tar.xz"
            tar -xf "$SDK_DIR/MacOSX.sdk.tar.xz" -C "$SDK_DIR"
          fi
          SDKROOT="$(ls -d "$SDK_DIR"/MacOSX*.sdk | head -n 1)"
          {
            printf "SDKROOT=%s\n" "$SDKROOT"
            echo "MACOSX_DEPLOYMENT_TARGET=12.0"
            echo "ZIG_SYSTEM_LIB_DIR=$SDKROOT/usr/lib"
          } >>"$GITHUB_ENV"
      - uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2.13.3"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SDKROOT: ${{ env.SDKROOT }}
          MACOSX_DEPLOYMENT_TARGET: ${{ env.MACOSX_DEPLOYMENT_TARGET }}
          ZIG_SYSTEM_LIB_DIR: ${{ env.ZIG_SYSTEM_LIB_DIR }}
